---
import Layout from '@/layouts/Layout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import CategoryHero from '@/components/product/CategoryHero.astro';
import CategorySidebar from '@/components/product/CategorySidebar.astro';
import ProductListCard from '@/components/product/ProductListCard.astro';
import productsData from '@/data/products.json';
import { readFileSync } from 'fs';
import { join } from 'path';

const products = productsData;
const category = products.categories.find(cat => cat.id === 'carrier-systems');
const allCategories = products.categories.map(cat => ({
  id: cat.id,
  name: cat.name,
  slug: cat.slug
}));

// Load processed products for images
let allProducts = [];
try {
  const processedData = JSON.parse(readFileSync(join(process.cwd(), 'prosista_products_processed.json'), 'utf-8'));
  allProducts = processedData.products || [];
} catch (e) {
  console.warn('Could not load processed products:', e.message);
}
---

<Layout 
  title={category?.meta_title || "Sisteme de sustinere"}
  description={category?.meta_description || "Sisteme de sustinere PROSISTA pentru proiecte comerciale si publice. Solutii durabile, estetice si conforme cerintelor arhitecturale moderne."}
>
  <!-- Hero Section -->
  <CategoryHero 
    title={category?.name || 'Sisteme de sustinere'}
    breadcrumbs={[
      { name: 'Acasă', href: '/' },
      { name: 'Sisteme de sustinere' }
    ]}
    backgroundImage={category?.image}
  />
  
  <!-- Main Content -->
  <Section padding="lg" class="py-12">
    <div class="w-full lg:w-[1320px] mx-auto px-5 lg:px-0">
      <div class="flex flex-col lg:flex-row" style="gap: 24px;">
        <!-- Sidebar -->
        <CategorySidebar 
          currentCategoryId="carrier-systems"
          allCategories={allCategories}
        />
        
        <!-- Main Content Grid -->
        <div class="w-full lg:w-[896px] flex-shrink-0">
          {category?.subcategories && category.subcategories.length > 0 ? (
            <>
              <!-- Subcategorii -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
                {category.subcategories.map((subcat, subcatIndex) => {
                  // Găsește prima poză de produs din subcategorie sau din categorie
                  let subcatImage = category?.image || '/images/products/sisteme-de-sustinere.jpg';
                  if (subcat.products && subcat.products.length > 0) {
                    const firstProduct = subcat.products[0];
                    const productData = allProducts.find(p => p.id === firstProduct.id);
                    if (productData?.main_image) {
                      // Extrage extensia din URL sau folosește .jpg ca default
                      const urlMatch = productData.main_image.match(/\.(jpg|jpeg|png|webp)(\?|$)/i);
                      const ext = urlMatch ? `.${urlMatch[1].toLowerCase()}` : '.jpg';
                      subcatImage = `/images/products-detail/sisteme-de-sustinere/${firstProduct.slug}-1${ext}`;
                    }
                  } else if (category.products && category.products.length > 0) {
                    // Dacă subcategoria nu are produse, folosește un produs diferit pentru fiecare subcategorie
                    const productIndex = subcatIndex % category.products.length;
                    const selectedProduct = category.products[productIndex];
                    const productData = allProducts.find(p => p.id === selectedProduct.id);
                    if (productData?.main_image) {
                      const urlMatch = productData.main_image.match(/\.(jpg|jpeg|png|webp)(\?|$)/i);
                      const ext = urlMatch ? `.${urlMatch[1].toLowerCase()}` : '.jpg';
                      subcatImage = `/images/products-detail/sisteme-de-sustinere/${selectedProduct.slug}-1${ext}`;
                    }
                  }
                  return (
                    <ProductListCard
                      name={subcat.name}
                      description={subcat.description || `Detalii despre ${subcat.name}`}
                      image={subcatImage}
                      href={`/produse/sisteme-de-sustinere/${subcat.slug}`}
                      categorySlug="sisteme-de-sustinere"
                    />
                  );
                })}
              </div>
            </>
          ) : (
              category?.products && category.products.length > 0 ? (
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
                {category.products.map(product => {
                  const productData = allProducts.find(p => p.id === product.id);
                  let productImage = category?.image || '/images/products/sisteme-de-sustinere.jpg';
                  if (productData?.main_image) {
                    // Extrage extensia din URL sau folosește .jpg ca default
                    const urlMatch = productData.main_image.match(/\.(jpg|jpeg|png|webp)(\?|$)/i);
                    const ext = urlMatch ? `.${urlMatch[1].toLowerCase()}` : '.jpg';
                    productImage = `/images/products-detail/sisteme-de-sustinere/${product.slug}-1${ext}`;
                  }
                  return (
                  <ProductListCard
                    name={product.name}
                    description={`Detalii despre ${product.name}`}
                    image={productImage}
                    href={`/produse/sisteme-de-sustinere/${product.slug}`}
                    categorySlug="sisteme-de-sustinere"
                  />
                )})}
              </div>
            ) : (
              <div class="text-center py-12">
                <p class="text-secondary-600">Nu există produse în această categorie.</p>
              </div>
            )
          )}
        </div>
      </div>
    </div>
  </Section>
</Layout>
