---
import Layout from '@/layouts/Layout.astro';
import Container from '@/components/ui/Container.astro';
---

<Layout title="Admin Panel - CMS">
  <Container>
    <div class="min-h-screen py-8">
      <h1 class="text-3xl font-bold mb-8">CMS Admin Panel</h1>
      
      <div id="admin-app" class="space-y-8">
        <!-- Categories Section -->
        <section class="bg-white p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Categorii</h2>
            <button 
              id="add-category-btn"
              class="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700"
            >
              + Adaugă Categorie
            </button>
          </div>
          <div id="categories-list" class="space-y-4"></div>
        </section>

        <!-- Products Section -->
        <section class="bg-white p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Produse</h2>
            <button 
              id="add-product-btn"
              class="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700"
            >
              + Adaugă Produs
            </button>
          </div>
          <div id="products-list" class="space-y-4"></div>
        </section>
      </div>

      <!-- Modal pentru editare -->
      <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-semibold">Editează</h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">✕</button>
          </div>
          <div id="modal-content"></div>
        </div>
      </div>
    </div>
  </Container>
</Layout>

<script>
  let productsData: any = null;

  // Load products data
  async function loadData() {
    try {
      const response = await fetch('/api/products');
      productsData = await response.json();
      renderCategories();
      renderProducts();
    } catch (error) {
      console.error('Error loading data:', error);
    }
  }

  // Render categories
  function renderCategories() {
    const container = document.getElementById('categories-list');
    if (!container || !productsData) return;

    container.innerHTML = productsData.categories.map((cat: any) => `
      <div class="border rounded p-4" data-category-id="${cat.id}">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h3 class="font-semibold text-lg">${cat.name}</h3>
            <p class="text-gray-600 text-sm">${cat.description || 'Fără descriere'}</p>
            <div class="mt-2">
              <button 
                onclick="editCategory('${cat.id}')"
                class="text-primary-600 hover:text-primary-700 mr-4"
              >
                Editează
              </button>
              <button 
                onclick="deleteCategory('${cat.id}')"
                class="text-red-600 hover:text-red-700"
              >
                Șterge
              </button>
            </div>
          </div>
        </div>
        ${cat.subcategories && cat.subcategories.length > 0 ? `
          <div class="mt-4 ml-4 border-l-2 pl-4">
            <h4 class="font-medium mb-2">Subcategorii:</h4>
            ${cat.subcategories.map((sub: any) => `
              <div class="mb-2">
                <span class="font-medium">${sub.name}</span>
                <span class="text-gray-500 text-sm ml-2">(${sub.products?.length || 0} produse)</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
        ${cat.products && cat.products.length > 0 ? `
          <div class="mt-4 ml-4">
            <h4 class="font-medium mb-2">Produse directe:</h4>
            <div class="text-sm text-gray-600">${cat.products.length} produse</div>
          </div>
        ` : ''}
      </div>
    `).join('');
  }

  // Render products
  function renderProducts() {
    const container = document.getElementById('products-list');
    if (!container || !productsData) return;

    const allProducts: any[] = [];
    
    productsData.categories.forEach((cat: any) => {
      // Direct products
      if (cat.products) {
        cat.products.forEach((p: any) => {
          allProducts.push({ ...p, category: cat.name, categoryId: cat.id });
        });
      }
      // Subcategory products
      if (cat.subcategories) {
        cat.subcategories.forEach((sub: any) => {
          if (sub.products) {
            sub.products.forEach((p: any) => {
              allProducts.push({ ...p, category: cat.name, subcategory: sub.name, categoryId: cat.id, subcategoryId: sub.id });
            });
          }
        });
      }
    });

    container.innerHTML = allProducts.map((product: any) => `
      <div class="border rounded p-4" data-product-id="${product.id}">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h3 class="font-semibold">${product.name}</h3>
            <p class="text-gray-600 text-sm">
              ${product.category}${product.subcategory ? ` > ${product.subcategory}` : ''}
            </p>
            ${product.description ? `<p class="text-gray-700 mt-2">${product.description.substring(0, 100)}...</p>` : ''}
            <div class="mt-2">
              <button 
                onclick="editProduct('${product.id}')"
                class="text-primary-600 hover:text-primary-700 mr-4"
              >
                Editează
              </button>
              <button 
                onclick="deleteProduct('${product.id}')"
                class="text-red-600 hover:text-red-700"
              >
                Șterge
              </button>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Show modal
  function showModal(title: string, content: string) {
    const modal = document.getElementById('edit-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    if (modal && modalTitle && modalContent) {
      modalTitle.textContent = title;
      modalContent.innerHTML = content;
      modal.classList.remove('hidden');
    }
  }

  function hideModal() {
    const modal = document.getElementById('edit-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  document.getElementById('close-modal')?.addEventListener('click', hideModal);
  document.getElementById('edit-modal')?.addEventListener('click', (e: any) => {
    if (e.target.id === 'edit-modal') hideModal();
  });

  // Edit category
  (window as any).editCategory = function(categoryId: string) {
    const category = productsData.categories.find((c: any) => c.id === categoryId);
    if (!category) return;

    const form = `
      <form id="category-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Nume Categorie</label>
          <input type="text" name="name" value="${category.name}" required 
            class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Descriere</label>
          <textarea name="description" rows="3" 
            class="w-full border rounded px-3 py-2">${category.description || ''}</textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">URL Imagine</label>
          <input type="text" name="image" value="${category.image || ''}" 
            class="w-full border rounded px-3 py-2" />
          <input type="file" id="category-image-upload" accept="image/*" class="mt-2" />
          <button type="button" onclick="uploadCategoryImage('${categoryId}')" 
            class="mt-2 bg-gray-200 px-3 py-1 rounded text-sm">Upload Imagine</button>
        </div>
        <div class="border-t pt-4">
          <h4 class="font-semibold mb-2">SEO</h4>
          <div class="space-y-2">
            <div>
              <label class="block text-sm font-medium mb-1">SEO Title</label>
              <input type="text" name="seoTitle" value="${category.seo?.title || ''}" 
                class="w-full border rounded px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">SEO Description</label>
              <textarea name="seoDescription" rows="2" 
                class="w-full border rounded px-3 py-2">${category.seo?.description || ''}</textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">SEO Keywords (separate prin virgulă)</label>
              <input type="text" name="seoKeywords" 
                value="${category.seo?.keywords?.join(', ') || ''}" 
                class="w-full border rounded px-3 py-2" />
            </div>
          </div>
        </div>
        <div class="flex gap-2 pt-4">
          <button type="submit" class="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700">
            Salvează
          </button>
          <button type="button" onclick="hideModal()" class="bg-gray-200 px-4 py-2 rounded">
            Anulează
          </button>
        </div>
      </form>
    `;

    showModal('Editează Categorie', form);

    document.getElementById('category-form')?.addEventListener('submit', async (e: any) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        image: formData.get('image'),
        seo: {
          title: formData.get('seoTitle'),
          description: formData.get('seoDescription'),
          keywords: (formData.get('seoKeywords') as string)?.split(',').map(k => k.trim()).filter(Boolean) || []
        }
      };
      await updateCategory(categoryId, data);
      hideModal();
    });
  };

  (window as any).uploadCategoryImage = async function(categoryId: string) {
    const input = document.getElementById('category-image-upload') as HTMLInputElement;
    if (!input?.files?.[0]) {
      alert('Selectează o imagine');
      return;
    }

    const formData = new FormData();
    formData.append('file', input.files[0]);

    try {
      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      if (result.success) {
        const imageInput = document.querySelector('input[name="image"]') as HTMLInputElement;
        if (imageInput) {
          imageInput.value = result.url;
        }
        alert('Imaginea a fost încărcată!');
      }
    } catch (error) {
      console.error('Error uploading image:', error);
      alert('Eroare la încărcarea imaginii');
    }
  };

  // Update category
  async function updateCategory(id: string, data: any) {
    try {
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'update',
          type: 'category',
          data: { id, ...data }
        })
      });
      
      if (response.ok) {
        await loadData();
        alert('Categoria a fost actualizată!');
      }
    } catch (error) {
      console.error('Error updating category:', error);
      alert('Eroare la actualizarea categoriei');
    }
  }

  // Delete category
  (window as any).deleteCategory = async function(categoryId: string) {
    if (!confirm('Sigur vrei să ștergi această categorie?')) return;

    try {
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'delete',
          type: 'category',
          id: categoryId
        })
      });
      
      if (response.ok) {
        await loadData();
        alert('Categoria a fost ștearsă!');
      }
    } catch (error) {
      console.error('Error deleting category:', error);
      alert('Eroare la ștergerea categoriei');
    }
  };

  // Edit product
  (window as any).editProduct = function(productId: string) {
    let product: any = null;
    let categoryId: string = '';
    let subcategoryId: string = '';

    // Find product
    for (const cat of productsData.categories) {
      if (cat.products) {
        const found = cat.products.find((p: any) => p.id === productId);
        if (found) {
          product = found;
          categoryId = cat.id;
          break;
        }
      }
      if (cat.subcategories) {
        for (const sub of cat.subcategories) {
          if (sub.products) {
            const found = sub.products.find((p: any) => p.id === productId);
            if (found) {
              product = found;
              categoryId = cat.id;
              subcategoryId = sub.id;
              break;
            }
          }
        }
      }
    }

    if (!product) return;

    const imagesList = (product.images || []).map((img: string) => `
      <div class="flex items-center gap-2 mb-2">
        <input type="text" value="${img}" name="images[]" class="flex-1 border rounded px-3 py-2" />
        <button type="button" onclick="this.parentElement.remove()" class="text-red-600">Șterge</button>
      </div>
    `).join('');

    const form = `
      <form id="product-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Nume Produs</label>
          <input type="text" name="name" value="${product.name}" required 
            class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Descriere</label>
          <textarea name="description" rows="5" 
            class="w-full border rounded px-3 py-2">${product.description || ''}</textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Imagini</label>
          <div id="images-list" class="space-y-2 mb-2">
            ${imagesList || '<p class="text-gray-500 text-sm">Nu există imagini</p>'}
          </div>
          <input type="file" id="product-image-upload" accept="image/*" class="mb-2" />
          <button type="button" onclick="uploadProductImage('${productId}')" 
            class="bg-gray-200 px-3 py-1 rounded text-sm">Upload Imagine</button>
          <button type="button" onclick="addImageField()" 
            class="ml-2 bg-gray-200 px-3 py-1 rounded text-sm">+ Adaugă URL</button>
        </div>
        <div class="border-t pt-4">
          <h4 class="font-semibold mb-2">SEO</h4>
          <div class="space-y-2">
            <div>
              <label class="block text-sm font-medium mb-1">SEO Title</label>
              <input type="text" name="seoTitle" value="${product.seo?.title || ''}" 
                class="w-full border rounded px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">SEO Description</label>
              <textarea name="seoDescription" rows="2" 
                class="w-full border rounded px-3 py-2">${product.seo?.description || ''}</textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">SEO Keywords (separate prin virgulă)</label>
              <input type="text" name="seoKeywords" 
                value="${product.seo?.keywords?.join(', ') || ''}" 
                class="w-full border rounded px-3 py-2" />
            </div>
          </div>
        </div>
        <div class="flex gap-2 pt-4">
          <button type="submit" class="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700">
            Salvează
          </button>
          <button type="button" onclick="hideModal()" class="bg-gray-200 px-4 py-2 rounded">
            Anulează
          </button>
        </div>
      </form>
    `;

    showModal('Editează Produs', form);

    document.getElementById('product-form')?.addEventListener('submit', async (e: any) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const images = Array.from(formData.getAll('images[]') as string[]).filter(Boolean);
      const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        images,
        seo: {
          title: formData.get('seoTitle'),
          description: formData.get('seoDescription'),
          keywords: (formData.get('seoKeywords') as string)?.split(',').map(k => k.trim()).filter(Boolean) || []
        }
      };
      await updateProduct(productId, data);
      hideModal();
    });
  };

  (window as any).addImageField = function() {
    const list = document.getElementById('images-list');
    if (list) {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2 mb-2';
      div.innerHTML = `
        <input type="text" name="images[]" placeholder="URL imagine" class="flex-1 border rounded px-3 py-2" />
        <button type="button" onclick="this.parentElement.remove()" class="text-red-600">Șterge</button>
      `;
      list.appendChild(div);
    }
  };

  (window as any).uploadProductImage = async function(productId: string) {
    const input = document.getElementById('product-image-upload') as HTMLInputElement;
    if (!input?.files?.[0]) {
      alert('Selectează o imagine');
      return;
    }

    const formData = new FormData();
    formData.append('file', input.files[0]);

    try {
      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      if (result.success) {
        const list = document.getElementById('images-list');
        if (list) {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2 mb-2';
          div.innerHTML = `
            <input type="text" value="${result.url}" name="images[]" class="flex-1 border rounded px-3 py-2" />
            <button type="button" onclick="this.parentElement.remove()" class="text-red-600">Șterge</button>
          `;
          list.appendChild(div);
        }
        alert('Imaginea a fost încărcată!');
      }
    } catch (error) {
      console.error('Error uploading image:', error);
      alert('Eroare la încărcarea imaginii');
    }
  };

  // Update product
  async function updateProduct(id: string, data: any) {
    try {
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'update',
          type: 'product',
          data: { id, ...data }
        })
      });
      
      if (response.ok) {
        await loadData();
        alert('Produsul a fost actualizat!');
      }
    } catch (error) {
      console.error('Error updating product:', error);
      alert('Eroare la actualizarea produsului');
    }
  }

  // Delete product
  (window as any).deleteProduct = async function(productId: string) {
    if (!confirm('Sigur vrei să ștergi acest produs?')) return;

    try {
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'delete',
          type: 'product',
          id: productId
        })
      });
      
      if (response.ok) {
        await loadData();
        alert('Produsul a fost șters!');
      }
    } catch (error) {
      console.error('Error deleting product:', error);
      alert('Eroare la ștergerea produsului');
    }
  };

  // Add category
  document.getElementById('add-category-btn')?.addEventListener('click', () => {
    const name = prompt('Nume categorie nouă:');
    if (!name) return;

    const slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    const description = prompt('Descriere:', '');
    const image = prompt('URL imagine:', '');

    createCategory({
      id: slug,
      name,
      slug,
      description,
      image,
      subcategories: [],
      products: [],
      seo: {}
    });
  });

  async function createCategory(data: any) {
    try {
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'create',
          type: 'category',
          data
        })
      });
      
      if (response.ok) {
        await loadData();
        alert('Categoria a fost creată!');
      }
    } catch (error) {
      console.error('Error creating category:', error);
      alert('Eroare la crearea categoriei');
    }
  }

  // Add product
  document.getElementById('add-product-btn')?.addEventListener('click', () => {
    if (!productsData || productsData.categories.length === 0) {
      alert('Nu există categorii. Creează mai întâi o categorie.');
      return;
    }

    const categoryOptions = productsData.categories.map((c: any, i: number) => 
      `${i + 1}. ${c.name}`
    ).join('\n');
    
    const categoryChoice = prompt(`Alege categoria (număr):\n${categoryOptions}`);
    if (!categoryChoice) return;

    const categoryIndex = parseInt(categoryChoice) - 1;
    if (categoryIndex < 0 || categoryIndex >= productsData.categories.length) {
      alert('Categorie invalidă');
      return;
    }

    const category = productsData.categories[categoryIndex];
    const name = prompt('Nume produs nou:');
    if (!name) return;

    const slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    const description = prompt('Descriere:', '');

    createProduct({
      id: slug,
      name,
      slug,
      description,
      images: [],
      seo: {}
    }, category.id, null);
  });

  async function createProduct(data: any, categoryId: string, subcategoryId: string | null) {
    try {
      const response = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'create',
          type: 'product',
          categoryId,
          subcategoryId,
          data
        })
      });
      
      if (response.ok) {
        await loadData();
        alert('Produsul a fost creat!');
      }
    } catch (error) {
      console.error('Error creating product:', error);
      alert('Eroare la crearea produsului');
    }
  }

  (window as any).hideModal = hideModal;

  // Initialize
  loadData();
</script>

<style>
  #admin-app {
    font-family: Arial, sans-serif;
  }
  
  #edit-modal {
    backdrop-filter: blur(4px);
  }
</style>

