---
import Layout from '@/layouts/Layout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import productsData from '@/data/products.json';
import { readFileSync, readdirSync, statSync, existsSync } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Flatten all products from categories and subcategories
interface ProductRow {
  id: string;
  category: string;
  categorySlug: string;
  subcategory: string;
  subcategorySlug: string;
  name: string;
  slug: string;
  image: string;
  pdfLink: string;
  productUrl: string;
  description: string;
  status: number; // 200 or 404
  imageExists: boolean;
}

// Category and subcategory structure
interface CategoryRow {
  categoryId: string;
  categoryName: string;
  categorySlug: string;
  categoryImage: string;
  subcategoryId: string;
  subcategoryName: string;
  subcategorySlug: string;
  subcategoryImage: string;
  productCount: number;
  status: number; // 200 or 404
  categoryImageExists: boolean;
}

const allProducts: ProductRow[] = [];
const allCategories: CategoryRow[] = [];
const missingImages: string[] = [];
const error404Urls: string[] = [];
const category404Urls: string[] = [];
const missingCategoryImages: string[] = [];

// Extract PDF links and descriptions from product pages
const pdfMap: Record<string, string> = {};
const descriptionMap: Record<string, string> = {};

function findAstroFiles(dir: string, fileList: string[] = []): string[] {
  const files = readdirSync(dir);
  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = statSync(filePath);
    if (stat.isDirectory()) {
      findAstroFiles(filePath, fileList);
    } else if (file.endsWith('.astro')) {
      fileList.push(filePath);
    }
  });
  return fileList;
}

function checkImageExists(imagePath: string): boolean {
  const publicDir = path.join(__dirname, '..', '..', 'public');
  const imagePathWithoutSlash = imagePath.startsWith('/') ? imagePath.slice(1) : imagePath;
  const basePath = path.join(publicDir, imagePathWithoutSlash);
  
  // Check for different extensions
  const extensions = ['.jpg', '.jpeg', '.png', '.webp'];
  for (const ext of extensions) {
    const imagePathWithExt = basePath.replace(/\.(jpg|jpeg|png|webp)$/i, ext);
    if (existsSync(imagePathWithExt)) {
      return true;
    }
  }
  
  // Also check the original path
  return existsSync(basePath);
}

try {
  const productsDir = path.join(__dirname, '..', 'pages', 'produse');
  const astroFiles = findAstroFiles(productsDir);
  
  astroFiles.forEach(filePath => {
    try {
      const content = readFileSync(filePath, 'utf-8');
      
      // Extract datasheetPdf or drawingPdf from ProductTabs component
      const datasheetMatch = content.match(/datasheetPdf=["']([^"']+)["']/);
      const drawingMatch = content.match(/drawingPdf=["']([^"']+)["']/);
      
      // Extract description - look for const description = `...` or const description = "..."
      const descriptionMatch = content.match(/const description\s*=\s*[`"]([^`"]+)[`"]/s) || 
                              content.match(/const description\s*=\s*`([^`]+)`/s);
      
      // Extract product slug from filename
      const filename = path.basename(filePath, '.astro');
      const pdf = datasheetMatch?.[1] || drawingMatch?.[1] || '';
      if (pdf && pdf.trim() !== '' && !pdf.includes('this.src') && pdf.startsWith('http')) {
        pdfMap[filename] = pdf;
      }
      
      // Extract and clean description
      if (descriptionMatch && descriptionMatch[1]) {
        let desc = descriptionMatch[1]
          .replace(/<[^>]+>/g, '') // Remove HTML tags
          .replace(/\n/g, ' ') // Replace newlines with spaces
          .replace(/\s+/g, ' ') // Replace multiple spaces with single space
          .trim();
        
        // Limit to 200 characters
        if (desc.length > 200) {
          desc = desc.substring(0, 200) + '...';
        }
        
        if (desc && desc.trim() !== '') {
          descriptionMap[filename] = desc;
        }
      }
    } catch (e) {
      // Skip files that can't be read
    }
  });
} catch (e) {
  // If reading fails, continue without PDFs
}

// Iterate through all categories
productsData.categories.forEach(category => {
  // Check category page and image
  const categoryUrl = `/categorii/${category.slug}`;
  const categoryPagePath = path.join(__dirname, '..', 'pages', 'categorii', `${category.slug}.astro`);
  const categoryStatus = existsSync(categoryPagePath) ? 200 : 404;
  const categoryImagePath = category.image || '/images/products/default.jpg';
  const categoryImageExists = checkImageExists(categoryImagePath);
  
  if (categoryStatus === 404) {
    category404Urls.push(categoryUrl);
  }
  if (!categoryImageExists) {
    missingCategoryImages.push(categoryImagePath);
  }
  
  // Add category row (even if no subcategories, show category)
  if (!category.subcategories || category.subcategories.length === 0) {
    const productCount = category.products ? category.products.length : 0;
    allCategories.push({
      categoryId: category.id,
      categoryName: category.name,
      categorySlug: category.slug,
      categoryImage: categoryImagePath,
      subcategoryId: '',
      subcategoryName: '',
      subcategorySlug: '',
      subcategoryImage: categoryImagePath,
      productCount: productCount,
      status: categoryStatus,
      categoryImageExists: categoryImageExists
    });
  }

  // Products directly in category
  if (category.products && category.products.length > 0) {
    category.products.forEach(product => {
      const productUrl = `/produse/${category.slug}/${product.slug}`;
      const imagePath = `/images/products-detail/${category.slug}/${product.slug}-1.jpg`;
      const productFilePath = path.join(__dirname, '..', 'pages', 'produse', category.slug, `${product.slug}.astro`);
      
      const status = existsSync(productFilePath) ? 200 : 404;
      const imageExists = checkImageExists(imagePath);
      
      if (status === 404) {
        error404Urls.push(productUrl);
      }
      if (!imageExists) {
        missingImages.push(imagePath);
      }
      
      allProducts.push({
        id: product.id,
        category: category.name,
        categorySlug: category.slug,
        subcategory: '',
        subcategorySlug: '',
        name: product.name,
        slug: product.slug,
        image: imagePath,
        pdfLink: pdfMap[product.slug] || '',
        productUrl: productUrl,
        description: descriptionMap[product.slug] || '',
        status: status,
        imageExists: imageExists
      });
    });
  }

  // Products in subcategories
  if (category.subcategories && category.subcategories.length > 0) {
    category.subcategories.forEach(subcategory => {
      // Add subcategory row
      const subcategoryProductCount = subcategory.products ? subcategory.products.length : 0;
      allCategories.push({
        categoryId: category.id,
        categoryName: category.name,
        categorySlug: category.slug,
        categoryImage: categoryImagePath,
        subcategoryId: subcategory.id,
        subcategoryName: subcategory.name,
        subcategorySlug: subcategory.slug,
        subcategoryImage: categoryImagePath,
        productCount: subcategoryProductCount,
        status: categoryStatus,
        categoryImageExists: categoryImageExists
      });

      if (subcategory.products && subcategory.products.length > 0) {
        subcategory.products.forEach(product => {
          const productUrl = `/produse/${category.slug}/${subcategory.slug}/${product.slug}`;
          const imagePath = `/images/products-detail/${category.slug}/${product.slug}-1.jpg`;
          const productFilePath = path.join(__dirname, '..', 'pages', 'produse', category.slug, subcategory.slug, `${product.slug}.astro`);
          
          const status = existsSync(productFilePath) ? 200 : 404;
          const imageExists = checkImageExists(imagePath);
          
          if (status === 404) {
            error404Urls.push(productUrl);
          }
          if (!imageExists) {
            missingImages.push(imagePath);
          }
          
          allProducts.push({
            id: product.id,
            category: category.name,
            categorySlug: category.slug,
            subcategory: subcategory.name,
            subcategorySlug: subcategory.slug,
            name: product.name,
            slug: product.slug,
            image: imagePath,
            pdfLink: pdfMap[product.slug] || '',
            productUrl: productUrl,
            description: descriptionMap[product.slug] || '',
            status: status,
            imageExists: imageExists
          });
        });
      }
    });
  }
});

// Calculate summary statistics
const uniqueCategories = new Set(allCategories.map(cat => cat.categoryId));
const totalCategories = uniqueCategories.size;
const totalSubcategories = allCategories.filter(cat => cat.subcategoryId !== '').length;
const totalProducts = allProducts.length;

// Sort categories by category name, then subcategory name
allCategories.sort((a, b) => {
  if (a.categoryName !== b.categoryName) {
    return a.categoryName.localeCompare(b.categoryName);
  }
  return a.subcategoryName.localeCompare(b.subcategoryName);
});

// Sort by category, then subcategory, then name
allProducts.sort((a, b) => {
  if (a.category !== b.category) {
    return a.category.localeCompare(b.category);
  }
  if (a.subcategory !== b.subcategory) {
    return a.subcategory.localeCompare(b.subcategory);
  }
  return a.name.localeCompare(b.name);
});
---

<Layout 
  title="Toate Produsele"
  description="Lista completă a tuturor produselor disponibile în catalogul PROSISTA"
>
  <Section padding="lg" class="py-12">
    <Container>
      <div class="mb-8">
        <h1 class="text-4xl font-bold mb-4" style="font-family: Arial, sans-serif; color: rgb(6, 59, 139);">
          Toate Produsele
        </h1>
        <p class="text-secondary-600 mb-6" style="font-family: Arial, sans-serif;">
          Lista completă a tuturor produselor disponibile în catalogul nostru
        </p>
        
        <!-- Summary -->
        <div class="bg-primary-50 border border-primary-200 rounded-lg p-6 mb-8">
          <h2 class="text-xl font-semibold mb-4" style="font-family: Arial, sans-serif; color: rgb(6, 59, 139);">
            Sumar
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 border border-primary-200">
              <div class="text-3xl font-bold text-primary-600" style="font-family: Arial, sans-serif;">
                {totalCategories}
              </div>
              <div class="text-sm text-secondary-600 mt-1" style="font-family: Arial, sans-serif;">
                Categorii
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-primary-200">
              <div class="text-3xl font-bold text-primary-600" style="font-family: Arial, sans-serif;">
                {totalSubcategories}
              </div>
              <div class="text-sm text-secondary-600 mt-1" style="font-family: Arial, sans-serif;">
                Subcategorii
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 border border-primary-200">
              <div class="text-3xl font-bold text-primary-600" style="font-family: Arial, sans-serif;">
                {totalProducts}
              </div>
              <div class="text-sm text-secondary-600 mt-1" style="font-family: Arial, sans-serif;">
                Produse
              </div>
            </div>
          </div>
          
          <!-- Error Summary -->
          <div class="mt-6 space-y-4">
            {error404Urls.length > 0 && (
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-2 text-red-800" style="font-family: Arial, sans-serif;">
                  Erori 404 ({error404Urls.length} URL-uri)
                </h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-red-700" style="font-family: Arial, sans-serif; max-height: 200px; overflow-y-auto;">
                  {error404Urls.map(url => (
                    <li>
                      <a href={url} target="_blank" rel="noopener noreferrer" class="hover:underline">
                        {url}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}
            
            {missingImages.length > 0 && (
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-2 text-yellow-800" style="font-family: Arial, sans-serif;">
                  Poze Lipsă ({missingImages.length} imagini)
                </h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-yellow-700" style="font-family: Arial, sans-serif; max-height: 200px; overflow-y-auto;">
                  {missingImages.map(img => (
                    <li>{img}</li>
                  ))}
                </ul>
              </div>
            )}
            
            {category404Urls.length > 0 && (
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-2 text-red-800" style="font-family: Arial, sans-serif;">
                  Categorii cu Erori 404 ({category404Urls.length} URL-uri)
                </h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-red-700" style="font-family: Arial, sans-serif; max-height: 200px; overflow-y-auto;">
                  {category404Urls.map(url => (
                    <li>
                      <a href={url} target="_blank" rel="noopener noreferrer" class="hover:underline">
                        {url}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            )}
            
            {missingCategoryImages.length > 0 && (
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-2 text-yellow-800" style="font-family: Arial, sans-serif;">
                  Poze Categorii Lipsă ({missingCategoryImages.length} imagini)
                </h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-yellow-700" style="font-family: Arial, sans-serif; max-height: 200px; overflow-y-auto;">
                  {missingCategoryImages.map(img => (
                    <li>{img}</li>
                  ))}
                </ul>
              </div>
            )}
            
            {error404Urls.length === 0 && missingImages.length === 0 && category404Urls.length === 0 && missingCategoryImages.length === 0 && (
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <p class="text-green-800 font-semibold" style="font-family: Arial, sans-serif;">
                  ✓ Toate paginile au status 200 și toate imaginile există!
                </p>
              </div>
            )}
          </div>
        </div>
      </div>

      <!-- Categories Table -->
      <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6" style="font-family: Arial, sans-serif; color: rgb(6, 59, 139);">
          Categorii și Subcategorii
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-secondary-200" style="font-family: Arial, sans-serif;">
            <thead class="bg-primary-600 text-white">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">ID Categorie</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Categorie</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Status</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Poza Categorie</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">ID Subcategorie</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Subcategorie</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Poza Subcategorie</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Nr. Produse</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-secondary-200">
              {allCategories.map((cat, index) => (
                <tr class={index % 2 === 0 ? 'bg-white' : 'bg-secondary-50'}>
                  <td class="px-4 py-3 text-sm text-secondary-900">{cat.categoryId}</td>
                  <td class="px-4 py-3 text-sm text-secondary-900 font-medium">
                    <a 
                      href={`/categorii/${cat.categorySlug}`}
                      class="text-primary-600 hover:text-primary-700 hover:underline"
                    >
                      {cat.categoryName}
                    </a>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span class={`inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${
                      cat.status === 200 
                        ? 'bg-green-100 text-green-800' 
                        : 'bg-red-100 text-red-800'
                    }`}>
                      {cat.status}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    {cat.categoryImageExists ? (
                      <img 
                        src={cat.categoryImage} 
                        alt={cat.categoryName}
                        class="w-24 h-24 object-cover rounded border border-secondary-200"
                        onerror="this.src='/images/products/default.jpg'; this.onerror=null;"
                      />
                    ) : (
                      <span class="text-yellow-600 text-xs font-semibold">❌ Lipsă</span>
                    )}
                  </td>
                  <td class="px-4 py-3 text-sm text-secondary-900">{cat.subcategoryId || '-'}</td>
                  <td class="px-4 py-3 text-sm text-secondary-900 font-medium">
                    {cat.subcategoryName ? (
                      <a 
                        href={`/produse/${cat.categorySlug}/${cat.subcategorySlug}`}
                        class="text-primary-600 hover:text-primary-700 hover:underline"
                      >
                        {cat.subcategoryName}
                      </a>
                    ) : (
                      '-'
                    )}
                  </td>
                  <td class="px-4 py-3 text-sm">
                    {cat.subcategoryName ? (
                      <img 
                        src={cat.subcategoryImage} 
                        alt={cat.subcategoryName}
                        class="w-24 h-24 object-cover rounded border border-secondary-200"
                        onerror="this.src='/images/products/default.jpg'; this.onerror=null;"
                      />
                    ) : (
                      <span class="text-secondary-400">-</span>
                    )}
                  </td>
                  <td class="px-4 py-3 text-sm text-secondary-900 font-semibold">{cat.productCount}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Products Table -->
      <div>
        <h2 class="text-2xl font-bold mb-6" style="font-family: Arial, sans-serif; color: rgb(6, 59, 139);">
          Toate Produsele
        </h2>
        <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-secondary-200" style="font-family: Arial, sans-serif;">
          <thead class="bg-primary-600 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">ID</th>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Categorie</th>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Subcategorie</th>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Nume Produs</th>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Status</th>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Poza Produs</th>
              <th class="px-4 py-3 text-left text-sm font-semibold uppercase">Link PDF</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-secondary-200">
            {allProducts.map((product, index) => (
              <tr class={index % 2 === 0 ? 'bg-white' : 'bg-secondary-50'}>
                <td class="px-4 py-3 text-sm text-secondary-900">{product.id}</td>
                <td class="px-4 py-3 text-sm text-secondary-900">
                  <a 
                    href={`/categorii/${product.categorySlug}`}
                    class="text-primary-600 hover:text-primary-700 hover:underline"
                  >
                    {product.category}
                  </a>
                </td>
                <td class="px-4 py-3 text-sm text-secondary-900">
                  {product.subcategory ? (
                    <a 
                      href={`/produse/${product.categorySlug}/${product.subcategorySlug}`}
                      class="text-primary-600 hover:text-primary-700 hover:underline"
                    >
                      {product.subcategory}
                    </a>
                  ) : (
                    '-'
                  )}
                </td>
                <td class="px-4 py-3 text-sm text-secondary-900 font-medium">
                  <a 
                    href={product.productUrl}
                    class="text-primary-600 hover:text-primary-700 hover:underline"
                  >
                    {product.name}
                  </a>
                </td>
                <td class="px-4 py-3 text-sm">
                  <span class={`inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${
                    product.status === 200 
                      ? 'bg-green-100 text-green-800' 
                      : 'bg-red-100 text-red-800'
                  }`}>
                    {product.status}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm">
                  {product.imageExists ? (
                    <img 
                      src={product.image} 
                      alt={product.name}
                      class="w-20 h-20 object-cover rounded border border-secondary-200"
                      onerror="this.src='/images/products/default.jpg'; this.onerror=null;"
                    />
                  ) : (
                    <span class="text-yellow-600 text-xs font-semibold">❌ Lipsă</span>
                  )}
                </td>
                <td class="px-4 py-3 text-sm">
                  {product.pdfLink ? (
                    <a 
                      href={product.pdfLink} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="text-primary-600 hover:text-primary-700 underline"
                    >
                      Descarcă PDF
                    </a>
                  ) : (
                    <span class="text-secondary-400">-</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      </div>
    </Container>
  </Section>
</Layout>

<style>
  table {
    border-collapse: collapse;
  }
  
  th, td {
    border: 1px solid #e5e7eb;
  }
  
  @media (max-width: 768px) {
    .overflow-x-auto {
      -webkit-overflow-scrolling: touch;
    }
  }
</style>
