---
import Layout from '@/layouts/Layout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import CategoryHero from '@/components/product/CategoryHero.astro';
import SubcategorySidebar from '@/components/product/SubcategorySidebar.astro';
import ProductCard from '@/components/product/ProductCard.astro';
import productsData from '@/data/products.json';
import { readFileSync } from 'fs';
import { join } from 'path';

const products = productsData;
const category = products.categories.find(cat => cat.slug === 'sisteme-de-tavane-metalice');
const subcategory = category?.subcategories?.find(sub => sub.slug === 'tavan-tip-grila-deschisa');
const allSubcategories = category?.subcategories || [];

// Load processed products for images
let allProducts = [];
try {
  const processedData = JSON.parse(readFileSync(join(process.cwd(), 'prosista_products_processed.json'), 'utf-8'));
  allProducts = processedData.products || [];
} catch (e) {
  console.warn('Could not load processed products:', e.message);
}
---
<Layout 
  title="Tavan tip grila deschisa"
  description="Tavan tip grila deschisa - Sisteme de tavane metalice"
>
  <!-- Hero Section -->
  <CategoryHero 
    title={subcategory?.name || 'Tavan tip grila deschisa'}
    breadcrumbs={[
      { name: 'Acasă', href: '/' },
      { name: 'Sisteme de tavane metalice', href: '/categorii/sisteme-de-tavane-metalice' },
      { name: 'Tavan tip grila deschisa' }
    ]}
    backgroundImage={category?.image}
    categorySlug="sisteme-de-tavane-metalice"
  />
  
  <!-- Main Content -->
  <Section padding="lg" class="py-12">
    <div class="w-full lg:w-[1320px] mx-auto px-5 lg:px-0">
      <div class="flex flex-col lg:flex-row" style="gap: 24px;">
        <!-- Sidebar -->
        <SubcategorySidebar 
          currentSubcategoryId="open-cell-ceiling"
          subcategories={allSubcategories.map(sub => ({
            id: sub.id,
            name: sub.name,
            slug: sub.slug
          }))}
          categorySlug="sisteme-de-tavane-metalice"
        />
        
        <!-- Main Content Grid -->
        <div class="w-full lg:w-[896px] flex-shrink-0">
          {subcategory?.products && subcategory.products.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
              {subcategory.products.map(product => {
                const productData = allProducts.find(p => p.id === product.id);
                let productImage = category?.image || '/images/products/sisteme-de-tavane-metalice.jpg';
                if (productData?.main_image) {
                  // Extrage extensia din URL sau folosește .jpg ca default
                  const urlMatch = productData.main_image.match(/\.(jpg|jpeg|png|webp)(\?|$)/i);
                  const ext = urlMatch ? `.${urlMatch[1].toLowerCase()}` : '.jpg';
                  productImage = `/images/products-detail/sisteme-de-tavane-metalice/${product.slug}-1${ext}`;
                }
                return (
                <ProductCard
                  name={product.name}
                  description={`Detalii despre ${product.name}`}
                  image={productImage}
                  href={`/produse/sisteme-de-tavane-metalice/tavan-tip-grila-deschisa/${product.slug}`}
                  categorySlug="sisteme-de-tavane-metalice"
                />
              )})}
            </div>
          ) : (
            <div class="text-center py-12">
              <p class="text-secondary-600">Nu există produse în această subcategorie.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </Section>
</Layout>
